/* Requires the Docker Pipeline plugin */
pipeline {
    agent any

    stages {
        stage('Setup parameters') {
            steps {
                script {
                    properties([
                        parameters([
                            choice(
                                choices: ['dev1', 'dev2', 'qa', 'peg', 'stg2', 'stg', 'prod2', 'prod'],
                                name: 'ENVIRONMENT',
                                defaultValue: 'dev2'
                            ),
                            string(
                                defaultValue: '23.3.0',
                                name: 'RELEASE'
                            ),
                            string(
                                defaultValue: 'TwilioUrlUpdate',
                                name: 'STEPNAME'
                            )
                        ])
                    ])
                }
            }
        }
        stage('Log Parameters') {
            steps {
                echo 'Environment = ' + params.ENVIRONMENT + '; Release = ' + params.RELEASE + '; Step Name = ' + params.STEPNAME
                echo ${WORKSPACE}
                echo pwd()
            }
        }
        stage('Validation') {
            steps {
                script {
                    def directory = "./" + params.RELEASE + "/" + params.STEPNAME + "/"
                    if (fileExists(directory)) {
                        echo "Dockerfile exists in " + directory
                    }
                    else {
                        echo "directory or Dockerfile does not exist in " + directory
                        currentBuild.result = 'FAILURE'
                        error("Stopping early!")
                    }
                }
            }
        }
        stage('Build Docker') {
            steps {
                dir('./Release/' + params.RELEASE + '/' + params.STEPNAME + '/') {
                    sh("""
                        docker build -f ./Dockerfile . -t velo-release-tasks
                    """)
                }
            }
        }
        stage('Run Docker') {
            steps {
                dir('./Release/' + params.RELEASE + '/' + params.STEPNAME + '/') {
                    sh("""
                        docker run "velo-release-tasks" --env ENVIRONMENT=${params.ENVIRONMENT}
                    """)
                }
            }
        }
    }
}
